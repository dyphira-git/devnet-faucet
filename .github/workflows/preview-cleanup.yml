name: Preview Cleanup

on:
  pull_request_target:
    types: [closed]

env:
  FLY_APP: republic-devnet-faucet

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Delete preview app
        run: |
          PREVIEW_APP="${{ env.FLY_APP }}-pr-${{ github.event.pull_request.number }}"
          if flyctl apps list | grep -q "$PREVIEW_APP"; then
            echo "Deleting preview app: $PREVIEW_APP"
            flyctl apps destroy "$PREVIEW_APP" --yes
          else
            echo "Preview app $PREVIEW_APP not found, skipping"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
